name: Deploy to VPS

on:
  push:
    branches:
      - deploy  # Triggers on push to deploy branch
  pull_request:
    branches:
      - main  # Run checks on PRs to main
      - deploy  # Run checks on PRs to deploy

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.2'  # Adjust based on your Python version

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          source $HOME/.cargo/env
          uv pip install --system ruff mypy
          uv pip install --system -r requirements.txt

      - name: Lint and format with Ruff
        run: |
          # Check formatting
          ruff format --check --diff .
          # Run linter
          ruff check .

      - name: Type check with mypy
        run: |
          mypy . --ignore-missing-imports || true  # Allow mypy to pass with warnings

  deploy:
    needs: lint-and-test  # Only deploy if linting passes
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/deploy' && github.event_name == 'push'  # Only deploy on deploy branch pushes
    
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üöÄ Starting deployment..."

            cd /root/stockalert

            echo "üì• Fetching changes from deploy branch..."
            git fetch origin deploy

            echo "‚úÖ Checking out only .py files and pages/..."
            git checkout origin/deploy -- '*.py' pages/

            if pm2 list | grep -q stockalerter; then
              pm2 restart stockalerter
            else
              pm2 start bash --name stockalerter -- -c "cd /root/stockalert && source venv/bin/activate && streamlit run Home.py --server.port 8503 --server.address 0.0.0.0"
              pm2 save
            fi
            echo "‚úÖ Deployment completed!"

      - name: Notify success on Discord
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{"content":"‚úÖ Deployment to VPS succeeded! üöÄ"}' \
            https://discord.com/api/webhooks/1352034334306992238/UvKcP8O5I9IzOQ7uE0HDcHa9NJT6gECkg5ZGS2PMRm-MH6ymUCKnFU3xTOy68qA82g4G

      - name: Notify failure on Discord
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{"content":"‚ùå Deployment to VPS failed! Check the GitHub Actions logs for details."}' \
            https://discord.com/api/webhooks/1352034334306992238/UvKcP8O5I9IzOQ7uE0HDcHa9NJT6gECkg5ZGS2PMRm-MH6ymUCKnFU3xTOy68qA82g4G
